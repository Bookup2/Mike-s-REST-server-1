unit Form.COWRegistrations;

interface

uses
  System.SysUtils, System.Types, System.UITypes, System.Classes, System.Variants,
  FMX.Types, FMX.Controls, FMX.Forms, FMX.Graphics, FMX.Dialogs,
  FMX.Controls.Presentation, FMX.StdCtrls, FMX.Menus;

type
  TCOWRegistrationWindow = class(TForm)
    DatabaseFileNameLabel: TLabel;
    PopupMenu1: TPopupMenu;
    MenuItem1: TMenuItem;
    ExportRegistrationsSaveDialog: TSaveDialog;
    procedure FormActivate(Sender: TObject);
    procedure MenuItem1Click(Sender: TObject);
  private
    { Private declarations }
    procedure ExportRegistrations;

  public
    { Public declarations }
  end;

var
  COWRegistrationWindow: TCOWRegistrationWindow;

implementation

{$R *.fmx}

uses Form.Main, RegistrationDatabase;

procedure TCOWRegistrationWindow.FormActivate(Sender: TObject);
begin
  DatabaseFileNameLabel.Text := MainForm.fRegistrationDatabaseFileName;
end;



procedure TCOWRegistrationWindow.MenuItem1Click(Sender: TObject);
begin
  ExportRegistrations;
end;



procedure TCOWRegistrationWindow.ExportRegistrations;
var
  theExportFile: TextFile;
  theEmailAddress: String;
  theIPAddresses: String;
  theFirstName: String;
  theLastName: String;
  theRegistrationStatus: String;
  theExpirationDate: TDateTime;

begin
  if not ExportRegistrationsSaveDialog.Execute then Exit;

  AssignFile(theExportFile, ExportRegistrationsSaveDialog.FileName);

  try

    try

      Rewrite(theExportFile);

      if not MainForm.fRegistrationDatabase.GetFirstRegistration(theEmailAddress)
        then
          begin
            CloseFile(theExportFile);
            Exit;
          end;

      repeat

        MainForm.fRegistrationDatabase.FillInEverything(theEmailAddress,
                                                        theIPAddresses,
                                                        thefirstName,
                                                        theLastName,
                                                        theRegistrationStatus,
                                                        theExpirationDate);

        WriteLn(theExportFile, theEmailAddress + ',' +
                               theIPAddresses + ',' +
                               thefirstName + ',' +
                               theLastName + ',' +
                               theRegistrationStatus + ',' +
                               theExpirationDate.ToString);

      until not MainForm.RegistrationDatabase.GetRegistrationAfter(theEmailAddress);

    except

      ShowMessage('Error writing to file: ' + ExportRegistrationsSaveDialog.FileName);
    end;

  finally

    CloseFile(theExportFile);

  end;

end;


end.
